# VQVAE Stage2 (from-scratch) config
# - code_dim=512, residual VQ (4 levels)
# - Physics constraints enabled early (start ~epoch 30-50) with ramps
# - ss_weight: small -> large -> small
# - rmsd_weight: large -> small -> large

model_params:
  name: "VQVAE-Stage2-FromScratch-Token64-K1024-D512"
  input_dim: 6
  hidden_dim: 512
  num_layers: 4
  num_heads: 8
  max_seq_len: 350

  # VQ core
  use_vq: true
  residual_vq: true
  num_quantizers: 4
  codebook_size: 1024        # codes per level, total codes = num_quantizers * codebook_size
  code_dim: 512
  beta: 0.0000               # will be overridden by schedule

  # Tokenizer (L -> N)
  latent_tokens: 64
  tokenizer_heads: 8
  tokenizer_layers: 2
  tokenizer_dropout: 0.10

  # Loss / regularizers
  label_smoothing: 0.01
  ss_tv_lambda: 0.002
  usage_entropy_lambda: 0.0
  xyz_align_alpha: 0.95
  dist_lambda: 0.0
  rigid_aug_prob: 0.0
  pairwise_sample_k: 32

  # Soft VQ (disabled for residual VQ)
  soft_vq_use: false
  soft_vq_tau_start: 2.0
  soft_vq_tau_end: 0.30
  soft_vq_tau_warm_steps: 8000
  soft_vq_alpha_warm_steps: 12000

  # EMA controls
  ema_decay_start: 0.98
  ema_decay_end: 0.98
  ema_decay_warm_steps: 12000
  ema_update_freeze_steps: 0

  # Codebook maintenance
  reinit_dead_codes: true
  reinit_prob: 0.25
  dead_usage_threshold: 1

  # Leave empty if passing via CLI
  codebook_init_path: ""

data_params:
  npy_dir: "/public/home/zhangyangroup/chengshiz/keyuan.zhou/prp-dataset/filtered_curves_npy/"
  train_list: "train_list.txt"
  val_list: "val_list.txt"
  train_batch_size: 128
  val_batch_size: 128
  num_workers: 8
  pin_memory: true

exp_params:
  LR: 0.00020
  weight_decay: 0.008
  manual_seed: 1265
  print_every: 900

  # Base weights (overridden by schedules)
  ss_weight: 0.80
  rmsd_weight: 1.80
  xyz_tv_lambda: 0.0000

  # Physics / geometry (overridden by schedules)
  bond_length_weight: 0.0000
  bond_angle_weight: 0.0000
  dir_weight: 0.0000
  dih_weight: 0.0000

  # Anti-crossing / global geometry consistency
  lr_pdm_weight: 0.0000
  pdm_weight: 0.0000
  win_kabsch_weight: 0.0000
  kappa_weight: 0.0
  tau_weight: 0.0

  # Geometry window parameters
  pdm_window: 8
  win_kabsch_size: 16
  win_kabsch_stride: 8
  lr_min_sep: 24
  lr_stride: 8
  lr_max_offsets: 8

  # Leave empty if passing via CLI
  warm_start_ckpt: ""

  checkpoint_dir: "./checkpoints/vq_token64_K1024_D512_ResidualVQ_fromscratch"
  save_every_epochs: 10
  checkpoint_name_pattern: "epoch{epoch:03d}"
  lr_scheduler: "none"

  schedules:
    # LR schedule (epoch-based, 0 -> 300)
    LR:
      - [0,    0.00020]
      - [30,   0.00020]
      - [180,  0.00010]
      - [200,  0.00002]

    # VQ beta schedule (slow ramp-up, then down)
    beta:
      - [0,    0.0005]
      - [5,    0.0015]
      - [20,   0.0030]
      - [80,   0.0050]
      - [140,  0.0060]
      - [200,  0.0030]

    # RMSD weight: large -> small -> large (xyz-focus -> ss/physics-focus -> rmsd fine-tune)
    rmsd_weight:
      - [0,    1.80]
      - [30,   1.80]
      - [80,   1.20]
      - [140,  0.90]
      - [200,  1.20]

    # SS weight: small -> large -> small
    ss_weight:
      - [0,    0.80]
      - [30,   0.80]
      - [80,   6.00]
      - [140,  10.0]
      - [200,  1.20]

    # Mild smoothness: useful mid-stage, relax late for RMSD fine-tune
    xyz_tv_lambda:
      - [0,    0.0000]
      - [60,   0.0008]
      - [160,  0.0010]
      - [200,  0.0005]
    

    # ----------------------------
    # Physics constraints (enabled early)
    # ----------------------------

    # Bond length constraint
    bond_length_weight:
      - [0,    0.0000]
      - [30,   0.0050]
      - [100,  0.0150]
      - [180,  0.0300]
      - [200,  0.0400]
    

    # Bond angle constraint
    bond_angle_weight:
      - [0,    0.0000]
      - [30,   0.0020]
      - [100,  0.0060]
      - [180,  0.0120]
      - [200,  0.0160]
    

    # Long-range PDM (anti-crossing / global distance consistency)
    lr_pdm_weight:
      - [0,    0.0000]
      - [40,   0.0010]
      - [120,  0.0030]
      - [180,  0.0060]
      - [200,  0.0100]
  

    # Local PDM (short-range shape consistency)
    pdm_weight:
      - [0,    0.0000]
      - [40,   0.0005]
      - [120,  0.0010]
      - [180,  0.0018]
      - [200,  0.0025]

    # Window Kabsch (local rigid consistency)
    win_kabsch_weight:
      - [0,    0.0000]
      - [60,   0.0002]
      - [150,  0.0006]
      - [200,  0.0010]
      

    # Keep these off unless you explicitly want to test them
    dir_weight:
      - [0,    0.0000]
      - [200,  0.0000]

    dih_weight:
      - [0,    0.0000]
      - [200,  0.0000]

    usage_entropy_lambda:
      - [0,    0.0000]
      - [200,  0.0000]

trainer_params:
  accelerator: gpu
  devices: 4
  strategy: ddp
  precision: 32
  max_epochs: 200
  log_every_n_steps: 10
  num_sanity_val_steps: 0
  benchmark: true
  enable_progress_bar: true
  gradient_clip_val: 3.0
  deterministic: false
  limit_val_batches: 0.25
  detect_anomaly: false

logging_params:
  save_dir: "./logs/"
  name: "VQ-stage2-token64-K1024-D512-ResidualVQ-fromscratch-physics"
