# Diffusion prior configuration (x-prediction on normalized z_q)

data:
  # JSONL manifest with indices_path, latent_len, target_len etc.
  train_manifest: "prior/out_prior_token64_K1024_D512_Residual_VQ_data/train/manifest.jsonl"
  val_manifest: "prior/out_prior_token64_K1024_D512_Residual_VQ_data/val/manifest.jsonl"

  # Pad token id used when extracting indices for prior training
  pad_token_id: 4096

  # Maximum flattened latent length (optional). Should be multiple of num_quantizers.
  max_len: 256

  batch_size: 64
  num_workers: 4
  pin_memory: true

  # Optional geometric conditioning (not used in this config)
  use_geo: false
  geo_dim: 0

  # Number of residual quantizers used by the VQ-VAE
  num_quantizers: 4

  # Length conditioning: enable p(z_q | L)
  use_length_cond: true
  # Maximum target length in the original curve space used for length normalization
  max_target_len: 350

vq:
  # You should override these with your actual VQ-VAE paths
  ckpt: "checkpoints/vq_token64_K1024_D512_ResidualVQ_fromscratch/epochepoch=139.ckpt"
  yaml: "configs/stage2_vq.yaml"

diffusion:
  # Number of diffusion steps T (training and sampling time index range 0..T-1)
  num_steps: 1000

  # Beta schedule used by GaussianDiffusion (DDPM-style)
  schedule: "cosine"    # or "linear"
  beta_start: 1.0e-4
  beta_end: 2.0e-2
  cosine_s: 0.008

model:
  # 1D ResNet denoiser configuration
  hidden_channels: 256
  time_embed_dim: 256
  num_blocks: 12
  dropout: 0.0

  # Dimension of length condition features (per token).
  # Effective cond_dim = geo_dim (if use_geo) + length_cond_dim.
  length_cond_dim: 1

optim:
  lr: 2.0e-4
  betas: [0.9, 0.99]
  weight_decay: 0.0

  max_updates: 80000
  warmup_updates: 2000
  grad_clip_norm: 1.0

ema:
  enable: true
  decay: 0.999

runtime:
  seed: 42
  amp: true
  device: "cuda"

  ckpt_dir: "prior/prior_ckpts/diffusion_prior_1_15"

  log_interval: 100
  eval_interval_updates: 2000
  save_interval_updates: 10000

  # Path to the z_q statistics computed by scripts/compute_zq_stats.py
  zq_stats_path: "prior/zq_stats_token64_K1024_D512.npz"
