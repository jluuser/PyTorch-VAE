All commands below assume your current directory is:

```bash
cd /public/home/zhangyangroup/chengshiz/keyuan.zhou/PyTorch-VAE
```

First, let's establish two environment variables (same as before):

## Step 1: Extract train / val indices from VQVAE (Unchanged)

> The output will be written to:
> `/public/home/zhangyangroup/chengshiz/keyuan.zhou/PyTorch-VAE/out_prior_data/{train,val}`
> This corresponds to the two manifests configured in your `prior/configs/prior_config.yaml`.

### 1.1 Extract train

```bash
torchrun --nproc_per_node=4 scripts/extract_code_indices.py \
  --ckpt  /public/home/zhangyangroup/chengshiz/keyuan.zhou/PyTorch-VAE/checkpoints/vq_token64_K1024_D512_ResidualVQ_fromscratch/epochepoch=139.ckpt \
  --yaml  /public/home/zhangyangroup/chengshiz/keyuan.zhou/PyTorch-VAE/configs/stage2_vq.yaml \
  --out_dir ./prior/out_prior_token64_K1024_D512_Residual_VQ_data/train \
  --split train \
  --num_workers 16 \
  --indices_dtype int16 \
  --expect_latent_len 256 \
  --pin_memory
```

### 1.2 Extract val

```bash
torchrun --nproc_per_node=4 scripts/extract_code_indices.py \
  --ckpt  /public/home/zhangyangroup/chengshiz/keyuan.zhou/PyTorch-VAE/checkpoints/vq_token64_K1024_D512_ResidualVQ_fromscratch/epochepoch=139.ckpt \
  --yaml  /public/home/zhangyangroup/chengshiz/keyuan.zhou/PyTorch-VAE/configs/stage2_vq.yaml \
  --out_dir ./prior/out_prior_token64_K1024_D512_Residual_VQ_data/val \
  --split val \
  --num_workers 16 \
  --indices_dtype int16 \
  --expect_latent_len 256 \
  --pin_memory
```

After running, you should have:

```text
out_prior_data/train/manifest.jsonl
out_prior_data/val/manifest.jsonl
```

These must match the paths in `prior/configs/prior_config.yaml`.

-----

## Step 2: Train **Transformer Prior**

```bash
python prior/train_diffusion.py \
  --config prior/configs/diffusion_config.yaml \
  --vq_ckpt checkpoints/vq_token64_K1024_D512_ResidualVQ_fromscratch/epochepoch=139.ckpt \
  --vq_yaml configs/stage2_vq.yaml

```

After training ends, the files will be located at:

```text
/public/home/zhangyangroup/chengshiz/keyuan.zhou/PyTorch-VAE/prior_ckpts/
    ├─ prior_best.pt   # best val_nll
    └─ prior_last.pt   # the last one

However, currently using: /public/home/zhangyangroup/chengshiz/keyuan.zhou/PyTorch-VAE/checkpoints/best_prior_ckpts    
```

-----

## Step 3: **Generate latent code sequences**

```bash
python prior/sample_diffusion.py \
  --ckpt /public/home/zhangyangroup/chengshiz/keyuan.zhou/PyTorch-VAE/prior/prior_ckpts/diffusion_prior_1_15/diffusion_prior_step70000.pt \
  --config prior/configs/diffusion_config.yaml \
  --vq_ckpt checkpoints/vq_token64_K1024_D512_ResidualVQ_fromscratch/epochepoch=139.ckpt \
  --vq_yaml configs/stage2_vq.yaml \
  --num_samples 10 \
  --batch_size 16 \
  --sample_steps 100 \
  --target_len 0 \
  --seed 42 \
  --out_dir prior/diffusion_prior_samples_step70000 \
  --device cuda

```

## Step 4: Decode generated codes into curves using VQVAE

```bash
python scripts/decode_with_vqvae.py \
  --vq_ckpt checkpoints/vq_token64_K1024_D512_ResidualVQ_fromscratch/epochepoch=139.ckpt \
  --vq_yaml configs/stage2_vq.yaml \
  --samples_manifest prior/diffusion_prior_samples_step70000/samples_manifest.jsonl \
  --out_dir prior/diffusion_prior_samples_step70000/redecoded \
  --device cuda \
  --limit 0 \
  --check_latent_len 0
```
## Step 5: filter

python prior/filter_curves.py \
  --recon_dir /public/home/zhangyangroup/chengshiz/keyuan.zhou/PyTorch-VAE/prior/new_prior_recons_1_8 \
  --out_dir /public/home/zhangyangroup/chengshiz/keyuan.zhou/PyTorch-VAE/prior/prior_filtered_recons\
  --samples_manifest /public/home/zhangyangroup/chengshiz/keyuan.zhou/PyTorch-VAE/prior/prior_samples_1_8_new/samples_manifest.jsonl \
  --filtered_manifest_out /public/home/zhangyangroup/chengshiz/keyuan.zhou/PyTorch-VAE/prior/prior_filtered_recons/manifest.jsonl \
  --min_pairwise_dist 3.0 \
  --neighbor_exclude 2 \
  --min_beta_run 0 \
  --min_beta_total 0 \
  --min_length 50
