
### 1.1 Extract train
```bash
torchrun --nproc_per_node=4 scripts/extract_code_indices.py \
  --ckpt  /public/home/zhangyangroup/chengshiz/keyuan.zhou/PyTorch-VAE/checkpoints/vq_token64_K1024_D512_ResidualVQ_fromscratch/epochepoch=139.ckpt \
  --yaml  /public/home/zhangyangroup/chengshiz/keyuan.zhou/PyTorch-VAE/configs/stage2_vq.yaml \
  --out_dir ./prior/out_prior_token64_K1024_D512_Residual_VQ_data/train \
  --split train \
  --num_workers 16 \
  --indices_dtype int16 \
  --expect_latent_len 256 \
  --pin_memory
```

### 1.2 Extract val

```bash
torchrun --nproc_per_node=4 scripts/extract_code_indices.py \
  --ckpt  /public/home/zhangyangroup/chengshiz/keyuan.zhou/PyTorch-VAE/checkpoints/vq_token64_K1024_D512_ResidualVQ_fromscratch/epochepoch=139.ckpt \
  --yaml  /public/home/zhangyangroup/chengshiz/keyuan.zhou/PyTorch-VAE/configs/stage2_vq.yaml \
  --out_dir ./prior/out_prior_token64_K1024_D512_Residual_VQ_data/val \
  --split val \
  --num_workers 16 \
  --indices_dtype int16 \
  --expect_latent_len 256 \
  --pin_memory
```
### 1.3
python scripts/compute_ze_stats.py \
  --manifest prior/out_prior_token64_K1024_D512_Residual_VQ_data/train/manifest.jsonl \
  --out prior/ze_stats_token64_K1024_D512.npz \
  --max_samples 0

-----

## Step 2: Train **Transformer Prior**

```bash
python prior/train_diffusion.py \
  --config prior/configs/diffusion_config.yaml \
  --vq_ckpt checkpoints/vq_token64_K1024_D512_ResidualVQ_fromscratch/epochepoch=139.ckpt \
  --vq_yaml configs/stage2_vq.yaml

```

After training ends, the files will be located at:

```text
/public/home/zhangyangroup/chengshiz/keyuan.zhou/PyTorch-VAE/prior_ckpts/
    ├─ prior_best.pt   # best val_nll
    └─ prior_last.pt   # the last one

However, currently using: /public/home/zhangyangroup/chengshiz/keyuan.zhou/PyTorch-VAE/checkpoints/best_prior_ckpts    
```

-----

## Step 3: **Generate latent code sequences**

```bash
python prior/sample_diffusion.py \
  --ckpt /public/home/zhangyangroup/chengshiz/keyuan.zhou/PyTorch-VAE/prior/prior_ckpts/diffusion_prior_1_17/diffusion_prior_step60000.pt \
  --config prior/configs/diffusion_config.yaml \
  --vq_ckpt checkpoints/vq_token64_K1024_D512_ResidualVQ_fromscratch/epochepoch=139.ckpt \
  --vq_yaml configs/stage2_vq.yaml \
  --num_samples 50 \
  --batch_size 16 \
  --sample_steps 250 \
  --target_len 40 \
  --seed 42 \
  --clip_norm 3.0 \
  --out_dir prior/diffusion_prior_samples_step60000 \
  --device cuda


```


```
## Step 4: filter

python prior/filter_curves.py \
  --recon_dir /public/home/zhangyangroup/chengshiz/keyuan.zhou/PyTorch-VAE/prior/diffusion_prior_samples_step60000/curves_npy \
  --out_dir /public/home/zhangyangroup/chengshiz/keyuan.zhou/PyTorch-VAE/prior/diffusion_prior_samples_step60000/curves_npy_filtered\
  --min_pairwise_dist 3.0 \
  --neighbor_exclude 2 \
  --min_beta_run 0 \
  --min_beta_total 0 \
  --min_length 2
